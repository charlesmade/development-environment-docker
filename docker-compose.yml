version: '3.2'
services:
  php-fpm:
    build: ./php/
    ports:
      - "9000:9000"
      - "9100:9100"
    links:
      - mysql-db:mysql-db
      - redis-db:redis-db
    volumes:
      - ./www/:/data/www/:rw
      - ./conf/php/:/usr/local/etc/php/:rw
      - ./conf/php-fpm/php-fpm.conf:/usr/local/etc/php-fpm.conf:rw
      - ./conf/php-fpm/conf.d/:/usr/local/etc/php-fpm.d/:rw
      - ./log/php-fpm/:/var/log/php-fpm/:rw
    restart: always
    command: php-fpm

  nginx:
    build: ./nginx/
    depends_on:
      - php-fpm
    links:
      - php-fpm:php-fpm
    volumes:
      - ./www/:/data/www/:rw
      - ./conf/nginx/nginx.conf:/etc/nginx/nginx.conf:rw
      - ./conf/nginx/conf.d/:/etc/nginx/conf.d/:rw
      - ./log/nginx/:/var/log/nginx/:rw
    ports:
      - "80:80"
      - "8080:8080"
      - "443:443"
    restart: always
    command: nginx -g 'daemon off;'

  mysql-db:
    build: ./mysql/
    ports:
      - "3306:3306"
    volumes:
      - ./data/mysql/:/var/lib/mysql/:rw
      - ./log/mysql/:/var/lib/mysql-logs/:rw
      - ./mysql/conf.d/:/etc/mysql/conf.d/:rw
    environment:
      MYSQL_ROOT_PASSWORD: 123456
      MYSQL_DATABASE: blog
      MYSQL_USER: root
      MYSQL_PASSWORD: 123456
    restart: always
    command: "--character-set-server=utf8"

  redis-db:
    build: ./redis/
    ports:
      - "6379:6379"
    volumes:
      - ./data/redis/:/data/
    restart: always

  nodejs:
    build: ./nodejs/
    volumes:
      - ./www/blog/:/src/:rw
      - ./modules/nodejs/:/src/node_modules:rw
    ports:
      - "9906:9906"
    command: "npm start"
    restart: always
